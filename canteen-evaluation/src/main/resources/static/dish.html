<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>菜品详情与评价</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .container { margin-top: 40px; max-width: 700px; }
        .dish-detail { box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 12px; background: #fff; padding: 24px; margin-bottom: 30px; }
        .dish-img { width: 100%; height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 16px; }
        .dish-title { font-size: 26px; font-weight: bold; color: #2d3436; margin-bottom: 8px; }
        .dish-price { color: #e67e22; font-weight: bold; font-size: 20px; margin-bottom: 8px; }
        .dish-ingredients, .dish-desc { color: #636e72; font-size: 15px; margin-bottom: 8px; }
        .back-link { color: #3498db; cursor: pointer; text-decoration: underline; margin-bottom: 16px; display: inline-block; }
        .eval-list { margin-top: 32px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px; }
        .eval-item { border-bottom: 1px solid #eee; padding: 12px 0; }
        .eval-item:last-child { border-bottom: none; }
        .eval-score { color: #f39c12; font-size: 16px; }
        .eval-user { color: #888; font-size: 13px; }
        .eval-comment { margin: 4px 0 0 0; font-size: 15px; }
        .eval-form { margin-top: 32px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px; }
        .eval-form input, .eval-form textarea, .eval-form select { width: 100%; margin-bottom: 12px; border-radius: 6px; border: 1px solid #dfe6e9; padding: 8px 10px; font-size: 15px; }
        .eval-form button { background: #2980b9; color: #fff; border: none; border-radius: 6px; padding: 8px 24px; font-size: 16px; transition: background 0.2s; }
        .eval-form button:hover { background: #3498db; }
        .msg-success { color: #27ae60; }
        .msg-error { color: #e74c3c; }
        .eval-actions { margin-top:6px; }
        .btn-del-eval { background:#e74c3c; border:none; color:#fff; padding:2px 10px; border-radius:4px; font-size:12px; cursor:pointer; }
        .btn-del-eval:hover { background:#c0392b; }
    </style>
</head>
<body>
<div id="app" class="container">
    <div class="back-link" @click="goBack">← 返回菜品列表</div>
    <div v-if="dish" class="dish-detail">
        <img :src="dish.photoUrl" alt="菜品图片" class="dish-img" v-if="dish.photoUrl">
        <div class="dish-title">{{ dish.name }}</div>
        <div class="dish-ingredients">原材料：{{ dish.ingredients }}</div>
        <div class="dish-price">￥{{ dish.price }}</div>
        <div class="dish-desc">{{ dish.description }}</div>
    </div>
    <div class="eval-list">
        <h4 class="mb-3" style="color:#2980b9;">评价列表</h4>
        <div v-if="evaluations.length === 0" class="text-muted">暂无评价</div>
        <div v-for="eval in evaluations" :key="eval.id" class="eval-item">
            <div class="eval-score">评分：{{ eval.score }} / 5</div>
            <div class="eval-user">用户ID：{{ eval.userId }} | {{ eval.createTime }}</div>
            <div class="eval-comment">{{ eval.comment }}</div>
            <div class="eval-actions" v-if="user && user.role==='admin'">
                <button class="btn-del-eval" @click="deleteEval(eval.id)">删除此评价</button>
            </div>
        </div>
    </div>
    <div class="eval-form mt-4" v-if="user">
        <h4 class="mb-3" style="color:#2980b9;">添加评价</h4>
        <select v-model="form.score">
            <option disabled value="">请选择评分</option>
            <option v-for="n in 5" :value="n">{{n}}</option>
        </select>
        <textarea v-model="form.comment" placeholder="您的评价" maxlength="200"></textarea>
        <button @click="submitEval">提交评价</button>
        <div v-if="msg" :class="msgClass">{{ msg }}</div>
    </div>
    <div class="mt-4" v-else>
        <div class="alert alert-info">请先 <a href="/user-login.html">登录</a> 后再进行评价。</div>
    </div>
</div>
<script>
function getQueryParam(name){ const params=new URLSearchParams(window.location.search); return params.get(name); }
function parseJwt(token){ try{const b64=token.split('.')[1];const b=b64.replace(/-/g,'+').replace(/_/g,'/');return JSON.parse(decodeURIComponent(escape(window.atob(b))));}catch(e){return null;} }
axios.interceptors.request.use(cfg=>{ const t=localStorage.getItem('token'); if(t) cfg.headers.Authorization='Bearer '+t; return cfg; });
new Vue({
    el:'#app',
    data:{ dish:null, evaluations:[], form:{ score:'', comment:'' }, msg:'', msgClass:'', user:null },
    created(){
        const token=localStorage.getItem('token');
        if(token){
            const payload=parseJwt(token);
            if(payload && payload.userId){ this.user={ id:payload.userId, username:payload.username, role:payload.role }; }
            else { localStorage.removeItem('token'); }
        }
        const id=getQueryParam('id'); if(!id) return;
        axios.get('/api/dishes/'+id).then(r=>{ this.dish=r.data; });
        this.loadEvaluations(id);
    },
    methods:{
        loadEvaluations(id){ axios.get('/api/evaluations/dish/'+id).then(r=>{ this.evaluations=r.data; }); },
        submitEval(){
            if(!this.user){ window.location.href='/user-login.html'; return; }
            if(!this.form.score || !this.form.comment){ this.msg='请填写完整信息'; this.msgClass='msg-error'; return; }
            const id=getQueryParam('id');
            axios.post('/api/evaluations', { dishId:id, score:this.form.score, comment:this.form.comment })
                .then(r=>{
                    if(r.data===true){
                        this.msg='评价提交成功！'; this.msgClass='msg-success';
                        this.form={ score:'', comment:'' }; this.loadEvaluations(id);
                    } else { this.msg='提交失败，可能未登录'; this.msgClass='msg-error'; }
                })
                .catch(()=>{ this.msg='提交失败，请重试'; this.msgClass='msg-error'; });
        },
        deleteEval(id){
            if(!this.user || this.user.role!=='admin') return;
            if(!confirm('确定要删除该评价吗？')) return;
            axios.delete('/api/evaluations/'+id).then(r=>{
                if(r.data===true){
                    const dishId = new URLSearchParams(window.location.search).get('id');
                    this.loadEvaluations(dishId);
                } else {
                    alert('删除失败：无权限或已被删除');
                }
            }).catch(()=> alert('删除失败，请重试'));
        },
        goBack(){ window.location.href='/index.html'; }
    }
});
</script>
</body>
</html>
